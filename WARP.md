# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Overview

Outline is a fast, collaborative knowledge base built with React and Node.js. This is a TypeScript monorepo with three main packages:

- **app/**: React frontend with MobX state management and Styled Components
- **server/**: Koa API server with Sequelize ORM, PostgreSQL, and Redis
- **shared/**: Common utilities, types, and editor components used across frontend and backend

## Key Technologies

- **Frontend**: React 17, MobX, Styled Components, Vite, ProseMirror editor
- **Backend**: Koa, Sequelize, PostgreSQL, Redis, Bull queues, Socket.io
- **Tooling**: TypeScript, Jest, Oxlint, Prettier, Docker
- **Real-time**: Hocuspocus collaboration server, Y.js for CRDT

## Essential Commands

### Development
```bash
# Start development environment (recommended)
make up                    # Starts Redis, Postgres, installs SSL certs, runs dev:watch
yarn dev:watch            # Runs backend rebuild + Vite dev server in parallel
yarn dev:backend          # Rebuild server on file changes only
yarn vite:dev             # Frontend dev server only
```

### Building
```bash
yarn build                # Build everything (frontend, i18n, server)
yarn build:server         # Build server only
yarn vite:build           # Build frontend only
```

### Testing
```bash
make test                  # Full test suite with DB setup
yarn test                 # Run all Jest projects
yarn test:app             # Frontend tests only
yarn test:server          # Backend tests only
yarn test:shared          # Shared code tests only
yarn test path/to/file.test.ts --watch  # Watch mode for specific test
make watch                 # Backend tests in watch mode
```

### Database
```bash
yarn db:create-migration --name my-migration
yarn db:migrate           # Run migrations
yarn db:rollback          # Undo last migration
yarn db:migrate --env test  # Run on test database
yarn db:reset             # Drop, create, migrate (development)
```

### Linting & Formatting
```bash
yarn lint                 # Oxlint type-aware linting
yarn lint:changed         # Lint only changed files
yarn format               # Format with Prettier
yarn format:check         # Check formatting without fixing
```

## Development Setup

### Environment Variables
Copy `.env.sample` to `.env` and configure:

```bash
# Required for local development
NODE_ENV=development
URL=https://localhost:3000
PORT=3000
SECRET_KEY=generate_a_new_key
UTILS_SECRET=generate_a_new_key

# Database (use docker-compose or local instance)
DATABASE_URL=postgres://user:pass@postgres:5432/outline
REDIS_URL=redis://redis:6379

# Optional: Enable debugging
DEBUG=http
LOG_LEVEL=debug
```

### Local Development with Docker
```bash
# Start dependencies (Redis + Postgres)
docker compose up -d redis postgres

# Or use the Makefile which includes SSL setup
make up
```

### Manual Database Setup
```bash
# Create database
yarn db:create
yarn db:migrate

# For test database
NODE_ENV=test yarn db:create
NODE_ENV=test yarn db:migrate
```

## Development Servers

- **Frontend**: http://localhost:3001 (Vite dev server)
- **Backend**: http://localhost:3000 (API server)
- **Collaboration**: WebSocket server runs on same port as API

The `yarn dev:watch` command runs both servers in parallel. HTTPS is available with local certificates (generated by `yarn install-local-ssl`).

## Testing Architecture

### Test Structure
- Jest with 4 projects: `app`, `server`, `shared-node`, `shared-jsdom`
- Tests are colocated with source files (`.test.ts` extension)
- Test database automatically set up with `make test`

### Running Tests
```bash
# Full test suite (includes DB setup)
make test

# Individual test projects
yarn test:app             # React components, hooks, utilities
yarn test:server          # API endpoints, models, services
yarn test:shared          # Shared utilities in both Node and JSDOM

# Development testing
yarn test --watch         # Watch mode
make watch                # Backend tests in watch mode
```

## Architecture Deep Dive

### Frontend (app/)
```
app/
├── actions/      # Reusable actions (navigate, create entities)
├── components/   # Shared React components
├── editor/       # Editor-specific React components
├── hooks/        # Custom React hooks
├── menus/        # Context menus
├── models/       # MobX state models
├── routes/       # Route definitions with async chunks
├── scenes/       # Full-page views
├── stores/       # Collections of models + fetch logic
└── utils/        # Frontend-specific utilities
```

### Backend (server/)
```
server/
├── routes/       # API and auth routes
├── commands/     # Complex multi-model operations
├── models/       # Sequelize models
├── policies/     # Authorization logic (cancan)
├── presenters/   # JSON serializers for API responses
├── queues/       # Background job definitions
├── services/     # Application services (api, worker, etc.)
├── middlewares/  # Koa middlewares
└── migrations/   # Database migrations
```

### Shared (shared/)
```
shared/
├── editor/       # ProseMirror editor (used by both frontend/backend)
├── components/   # Shared React components
├── i18n/         # Internationalization
├── styles/       # Global styles and themes
└── utils/        # Cross-platform utilities
```

## Important Scripts & Aliases

Path aliases in TypeScript:
- `~/*` → `app/*`
- `@shared/*` → `shared/*`
- `@server/*` → `server/*`

Build configuration:
- Frontend uses Vite with React plugin
- Backend uses custom build script (`build.js`)
- Shared code compiled with Babel

## Debugging & Development Tips

### Environment-Specific Behavior
- Development: Detailed console logging, file watching, HTTPS with local certs
- Production: JSON structured logs, optimized builds
- Test: UTC timezone forced, in-memory Redis, separate test database

### Common Issues
- **Port conflicts**: Check PORT in `.env`, default is 3000 for API, 3001 for Vite
- **Database connection**: Ensure PostgreSQL is running and DATABASE_URL is correct
- **SSL certificates**: Run `yarn install-local-ssl` if HTTPS is needed locally
- **Build failures**: Clear `build/` directory with `yarn clean`

### Useful Debug Settings
```bash
DEBUG=*                    # Enable all debug output
DEBUG=http                 # HTTP request logging
DEBUG=database             # Database query logging
LOG_LEVEL=silly           # Maximum verbosity
```

## Documentation References

- [README.md](README.md) - Installation and contribution guidelines
- [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md) - Detailed system architecture
- [AGENTS.md](AGENTS.md) - Repository guidelines for agents and contributors
- [docs/SERVICES.md](docs/SERVICES.md) - Service configuration details